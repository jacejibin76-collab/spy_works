<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Shadow Directorate - Mission Control</title>
<style>
body {
    background:black;
    color:#00ff88;
    font-family:monospace;
    margin:0;
    padding:20px;
}
#terminal{
    white-space: pre-line;
    font-size:18px;
}
button{
    background:black;
    color:#00ff88;
    border:1px solid #00ff88;
    padding:10px;
    margin:5px;
    cursor:pointer;
    font-family:monospace;
}
button:hover{
    background:#00ff88;
    color:black;
}
.red{color:red;}
#qrVideo {
    width: 300px;
    height: 300px;
    border: 1px solid #00ff88;
    margin-top: 20px;
}
</style>
</head>
<body>
<div id="terminal">INITIALIZING SECURE TERMINAL...</div>
<div id="missions"></div>
<video id="qrVideo" hidden></video>

<script src="https://unpkg.com/html5-qrcode@2.3.7/minified/html5-qrcode.min.js"></script>
<script>
// --- AGENTS ---
const agents = ["PHANTOM","RAVEN","VIPER","GHOST"];

// --- MISSIONS PER AGENT ---
const agentMissions = {
    "PHANTOM":[
        {name:"Silent Extraction", location:"Sector 7", objective:"Retrieve sensitive data without alerting guards", capsule:"PHANTOM-C1"},
        {name:"Ghost Recon", location:"Grid 12", objective:"Scout enemy base undetected", capsule:"PHANTOM-C2"},
        {name:"Data Heist", location:"Server Room X", objective:"Exfiltrate critical intel", capsule:"PHANTOM-C3"}
    ],
    "RAVEN":[
        {name:"Night Surveillance", location:"Tower 5", objective:"Monitor communications covertly", capsule:"RAVEN-C1"},
        {name:"Asset Escort", location:"Black Site", objective:"Secure and transport target safely", capsule:"RAVEN-C2"},
        {name:"Intel Gathering", location:"Data Node Z", objective:"Collect enemy schematics", capsule:"RAVEN-C3"}
    ],
    "VIPER":[
        {name:"Weapon Intercept", location:"Dock 9", objective:"Prevent illegal weapons shipment", capsule:"VIPER-C1"},
        {name:"Sabotage", location:"Factory 17", objective:"Disable enemy machinery", capsule:"VIPER-C2"},
        {name:"Extraction", location:"Safehouse B", objective:"Retrieve VIP safely", capsule:"VIPER-C3"}
    ],
    "GHOST":[
        {name:"Recon Ops", location:"Sector 21", objective:"Map enemy territory", capsule:"GHOST-C1"},
        {name:"Intercept Communication", location:"Signal Tower", objective:"Decode enemy transmissions", capsule:"GHOST-C2"},
        {name:"Stealth Recovery", location:"Abandoned Base", objective:"Recover lost intel", capsule:"GHOST-C3"}
    ]
};

// --- GET AGENT FROM URL ---
const params = new URLSearchParams(window.location.search);
const agent = params.get("agent") ? params.get("agent").toUpperCase() : null;

const terminal = document.getElementById("terminal");
const missionsDiv = document.getElementById("missions");
const qrVideo = document.getElementById("qrVideo");

// --- TYPING EFFECT ---
function typeText(text, speed=40, callback=null){
    let i=0;
    function type(){
        if(i<text.length){
            terminal.innerHTML += text.charAt(i);
            i++;
            setTimeout(type,speed);
        }else if(callback) callback();
    }
    type();
}

// --- DISPLAY MISSIONS ---
function showMissions(agent){
    terminal.innerHTML = `AGENT: ${agent}\nSECURE TERMINAL ONLINE\n\nAvailable Missions:\n`;
    const missions = agentMissions[agent];
    missionsDiv.innerHTML = "";
    missions.forEach((m,index)=>{
        let btn = document.createElement("button");
        btn.innerText = m.name;
        btn.onclick = ()=>showMissionDetail(agent,index);
        missionsDiv.appendChild(btn);
    });
}

// --- DISPLAY MISSION DETAILS ---
function showMissionDetail(agent,index){
    const mission = agentMissions[agent][index];
    terminal.innerHTML = `AGENT: ${agent}\nMISSION: ${mission.name}\n\nLocation: ${mission.location}\nObjective: ${mission.objective}\nCapsule: ${mission.capsule}\n\nScan capsule QR to unlock next mission.`;
    missionsDiv.innerHTML = "";
    qrVideo.hidden = false;
    startQrScanner(agent,index);
}

// --- QR SCANNER ---
function startQrScanner(agent,index){
    const html5QrCode = new Html5Qrcode("qrVideo");
    html5QrCode.start(
        { facingMode: "environment" },
        { fps:10, qrbox:250 },
        qrCodeMessage => {
            if(qrCodeMessage === agentMissions[agent][index].capsule){
                html5QrCode.stop();
                qrVideo.hidden = true;
                alert("Capsule verified. Next mission unlocked!");
                if(index+1 < agentMissions[agent].length){
                    showMissionDetail(agent,index+1);
                } else {
                    showMissions(agent);
                }
            } else {
                alert("Invalid QR. Access denied.");
            }
        }
    ).catch(err=>{
        console.error("QR scan error:", err);
    });
}

// --- START TERMINAL ---
if(agent && agents.includes(agent)){
    typeText(`AGENT IDENTIFIED: ${agent}\nWelcome to Shadow Directorate\nInitializing Mission Protocols...\n\n`,40, ()=>showMissions(agent));
}else{
    terminal.innerHTML = "UNAUTHORIZED ACCESS DETECTED\n\nTERMINAL LOCKED";
    terminal.classList.add("red");
}
</script>
</body>
</html>
